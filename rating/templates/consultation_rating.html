<!-- rating/templates/rating/consultation_rating.html -->
{% extends "base.html" %}
{% load static %}

{% block meta %}
<title>Rate Consultation - PandaCare</title>
{% endblock meta %}

{% block navbar %}
{% include "components/navbar.html" with is_logged_in=is_logged_in user_role=user_role %}
{% endblock navbar %}

{% block content %}
<div class="flex-grow container mx-auto p-6 max-w-4xl">
    <!-- Back button -->
    <div class="mb-4">
        <a href="{% url 'rating:rating_list' %}" class="inline-flex items-center text-primary hover:text-accent-500 transition-colors">
            <i class="fas fa-arrow-left mr-2"></i> Back to My Ratings
        </a>
    </div>

    <div class="bg-white rounded-xl shadow-sm p-8">
        {% if has_rated and existing_rating %}
        <!-- Update Rating Form -->
        <div class="text-center mb-8">
            <div class="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-edit text-yellow-600 text-2xl"></i>
            </div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Update Your Rating</h1>
            <p class="text-gray-600">You can update or delete your existing rating for this consultation</p>
        </div>

        <form id="ratingForm" class="max-w-md mx-auto">
            {% csrf_token %}
            <input type="hidden" name="action" value="update_rating">

            <div class="mb-6">
                <label class="block text-gray-700 font-medium mb-3 text-center">Your Rating</label>
                <div class="flex justify-center items-center space-x-2 mb-4" id="starRating">
                    {% for i in "12345" %}
                    <button type="button" class="star-button text-3xl text-gray-300 hover:text-yellow-400 transition-colors"
                            data-rating="{{ forloop.counter }}" onclick="setRating({{ forloop.counter }})">
                        <i class="fas fa-star"></i>
                    </button>
                    {% endfor %}
                </div>
                <input type="hidden" id="ratingValue" name="rating" value="{{ existing_rating.ratingScore }}">
                <p class="text-center text-gray-500 text-sm">Click on stars to rate</p>
            </div>

            <div class="mb-6">
                <label for="comment" class="block text-gray-700 font-medium mb-2">Your Review</label>
                <textarea id="comment" name="comment" rows="4"
                          class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                          placeholder="Share your experience with this consultation...">{{ existing_rating.ulasan }}</textarea>
            </div>

            <div class="flex space-x-3">
                <button type="button" onclick="deleteRating()"
                        class="flex-1 bg-red-100 text-red-600 py-3 px-4 rounded-lg hover:bg-red-200 transition-all font-medium">
                    <i class="fas fa-trash mr-2"></i>Delete Rating
                </button>
                <button type="submit"
                        class="flex-1 bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-all font-medium">
                    <i class="fas fa-save mr-2"></i>Update Rating
                </button>
            </div>
        </form>

        {% else %}
        <!-- Add New Rating Form -->
        <div class="text-center mb-8">
            <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-star text-blue-600 text-2xl"></i>
            </div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Rate Your Consultation</h1>
            <p class="text-gray-600">Share your experience to help other patients and improve our service</p>
        </div>

        <form id="ratingForm" class="max-w-md mx-auto">
            {% csrf_token %}
            <input type="hidden" name="action" value="add_rating">

            <div class="mb-6">
                <label class="block text-gray-700 font-medium mb-3 text-center">Rate Your Experience</label>
                <div class="flex justify-center items-center space-x-2 mb-4" id="starRating">
                    {% for i in "12345" %}
                    <button type="button" class="star-button text-3xl text-gray-300 hover:text-yellow-400 transition-colors"
                            data-rating="{{ forloop.counter }}" onclick="setRating({{ forloop.counter }})">
                        <i class="fas fa-star"></i>
                    </button>
                    {% endfor %}
                </div>
                <input type="hidden" id="ratingValue" name="rating" value="">
                <p class="text-center text-gray-500 text-sm">Click on stars to rate</p>
            </div>

            <div class="mb-6">
                <label for="comment" class="block text-gray-700 font-medium mb-2">Your Review</label>
                <textarea id="comment" name="comment" rows="4"
                          class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                          placeholder="Share your experience with this consultation..." required></textarea>
            </div>

            <button type="submit"
                    class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-all font-medium">
                <i class="fas fa-paper-plane mr-2"></i>Submit Rating
            </button>
        </form>
        {% endif %}

        <!-- Consultation Info -->
        <div class="mt-8 pt-6 border-t border-gray-200">
            <h3 class="text-lg font-semibold text-gray-800 mb-3">Consultation Details</h3>
            <div class="bg-gray-50 rounded-lg p-4">
                <p class="text-sm text-gray-600">
                    <strong>Consultation ID:</strong> {{ consultation_id|slice:":8" }}...
                </p>
                {% if existing_rating %}
                <p class="text-sm text-gray-600 mt-2">
                    <strong>Last Updated:</strong> {{ existing_rating.updatedAt|date:"d M Y, H:i" }}
                </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-30 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 shadow-xl">
        <div class="flex items-center space-x-3">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
            <span class="text-gray-700">Processing...</span>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md m-4">
        <div class="text-center">
            <div class="mb-4">
                <i class="fas fa-exclamation-triangle text-red-500 text-4xl"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Delete Rating</h3>
            <p class="text-gray-600 mb-6">Are you sure you want to delete this rating? This action cannot be undone.</p>

            <div class="flex space-x-3">
                <button onclick="closeDeleteModal()"
                        class="flex-1 bg-gray-200 text-gray-700 py-3 px-4 rounded-lg hover:bg-gray-300 transition-all">
                    Cancel
                </button>
                <button onclick="confirmDelete()"
                        class="flex-1 bg-red-600 text-white py-3 px-4 rounded-lg hover:bg-red-700 transition-all">
                    Delete
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_style %}
<style>
    .star-button {
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .star-button:hover {
        transform: scale(1.1);
    }

    .star-button.active {
        color: #fbbf24 !important;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .bg-white {
        animation: fadeIn 0.5s ease-out;
    }
</style>
{% endblock extra_style %}

{% block extra_js %}
<script>
    let currentRating = {% if existing_rating %}{{ existing_rating.ratingScore }}{% else %}0{% endif %};

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function showLoading() {
        document.getElementById('loadingOverlay').classList.remove('hidden');
    }

    function hideLoading() {
        document.getElementById('loadingOverlay').classList.add('hidden');
    }

    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm ${
            type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                    'bg-blue-500 text-white'
        }`;
        toast.innerHTML = `
        <div class="flex items-center">
            <i class="fas ${
            type === 'success' ? 'fa-check-circle' :
                type === 'error' ? 'fa-exclamation-circle' :
                    'fa-info-circle'
        } mr-2"></i>
            <span>${message}</span>
        </div>
    `;

        document.body.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    function setRating(rating) {
        currentRating = rating;
        document.getElementById('ratingValue').value = rating;

        const stars = document.querySelectorAll('.star-button');
        stars.forEach((star, index) => {
            if (index < rating) {
                star.classList.add('active');
                star.classList.remove('text-gray-300');
                star.classList.add('text-yellow-400');
            } else {
                star.classList.remove('active');
                star.classList.remove('text-yellow-400');
                star.classList.add('text-gray-300');
            }
        });
    }

    function deleteRating() {
        document.getElementById('deleteConfirmModal').classList.remove('hidden');
    }

    function closeDeleteModal() {
        document.getElementById('deleteConfirmModal').classList.add('hidden');
    }

    function confirmDelete() {
        showLoading();

        fetch(`{% url 'rating:rating_action' consultation_id=consultation_id %}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: 'action=delete_rating'
        })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                closeDeleteModal();

                if (data.success) {
                    showToast(data.message, 'success');
                    setTimeout(() => {
                        window.location.href = "{% url 'rating:rating_list' %}";
                    }, 1500);
                } else {
                    showToast(data.error || 'Failed to delete rating', 'error');
                }
            })
            .catch(error => {
                hideLoading();
                closeDeleteModal();
                console.error('Error:', error);
                showToast('An error occurred while deleting rating.', 'error');
            });
    }

    // Initialize rating if editing existing rating
    document.addEventListener('DOMContentLoaded', function() {
        {% if existing_rating %}
        setRating({{ existing_rating.ratingScore }});
        {% endif %}
    });

    // Handle form submission
    document.getElementById('ratingForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const rating = document.getElementById('ratingValue').value;
        const comment = document.getElementById('comment').value;

        if (!rating || rating < 1 || rating > 5) {
            showToast('Please select a rating from 1-5 stars.', 'error');
            return;
        }

        if (!comment.trim()) {
            showToast('Please enter a review.', 'error');
            return;
        }

        showLoading();

        fetch(`{% url 'rating:rating_action' consultation_id=consultation_id %}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                hideLoading();

                if (data.success) {
                    showToast(data.message, 'success');
                    setTimeout(() => {
                        window.location.href = "{% url 'rating:rating_list' %}";
                    }, 1500);
                } else {
                    showToast(data.error || 'Failed to submit rating', 'error');
                }
            })
            .catch(error => {
                hideLoading();
                console.error('Error:', error);
                showToast('An error occurred while submitting rating.', 'error');
            });
    });

    // Close modal when clicking outside
    document.getElementById('deleteConfirmModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeDeleteModal();
        }
    });
</script>
{% endblock extra_js %}