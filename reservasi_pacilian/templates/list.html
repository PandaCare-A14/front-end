{% extends "base.html" %}
{% load static %}

{% block meta %}
<title>My Reservations - PandaCare</title>
{% endblock meta %}

{% block navbar %}
{% include "components/navbar.html" with is_logged_in=is_logged_in user_role=user_role user_id=user_id %}
{% endblock navbar %}

{% block content %}
<div class="flex-grow container mx-auto p-6 max-w-7xl">
    <!-- Page Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h3 class="text-2xl font-bold text-gray-800">My Reservations</h3>
            <p class="text-sm text-gray-600">View and manage your consultation appointments</p>
        </div>
        <div class="flex space-x-3">
            <a href="{% url 'doctor_profile:search' %}" class="btn-secondary">
                <i class="fas fa-user-md mr-2"></i> Browse Doctors
            </a>
            <a href="{% url 'doctor_profile:search' %}" class="btn-primary">
                <i class="fas fa-plus mr-2"></i> New Reservation
            </a>
        </div>
    </div>

    <!-- Reservations List -->
    <div class="space-y-4">
        {% if reservasis %}
        {% for reservasi in reservasis %}
        <div class="reservation-card" data-reservation-id="{{ reservasi.id }}"
            data-caregiver-id="{{ reservasi.idSchedule.idCaregiver }}">
            <!-- Card Header -->
            <div class="card-header">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <div class="reservation-icon">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="ml-4">
                            <h3 class="reservation-title">Reservation #{{ reservasi.id }}</h3>
                            <p class="reservation-subtitle">
                                <i class="fas fa-user-md mr-1"></i>
                                Doctor ID: {{ reservasi.idSchedule.idCaregiver}}
                            </p>
                        </div>
                    </div>
                    <!-- Status Badge -->
                    <span class="status-badge" data-status="{{ reservasi.statusReservasi }}">
                        {{ reservasi.statusReservasi }}
                    </span>
                </div>
            </div>

            <!-- Card Content -->
            <div class="card-content">
                <!-- Schedule Information -->
                {% if reservasi.idSchedule %}
                <div class="info-section schedule-info">
                    <div class="info-header">
                        <i class="fas fa-calendar-alt mr-2"></i>
                        <strong>Appointment Schedule</strong>
                    </div>
                    <div class="info-content">
                        {% if reservasi.idSchedule.date %}
                        <span class="schedule-date">{{ reservasi.idSchedule.date|date:"l, F j, Y" }}</span>
                        {% endif %}
                        {% if reservasi.idSchedule.startTime and reservasi.idSchedule.endTime %}
                        <span class="schedule-time">{{ reservasi.idSchedule.startTime }} -
                            {{ reservasi.idSchedule.endTime }}</span>
                        {% endif %}
                        <span class="schedule-time">{{ reservasi.idSchedule.day }}</span>
                    </div>
                </div>
                {% endif %}

                <!-- Patient Note -->
                <div class="info-section note-info">
                    <div class="info-header">
                        <i class="fas fa-sticky-note mr-2"></i>
                        <strong>Your Note</strong>
                    </div>
                    <div class="info-content">
                        <p class="note-text">{{ reservasi.pacilianNote }}</p>
                    </div>
                </div>

                <!-- Caregiver Note -->
                {% if reservasi.caregiverNote or reservasi.caregiver_note %}
                <div class="info-section caregiver-note">
                    <div class="info-header">
                        <i class="fas fa-user-md mr-2"></i>
                        <strong>Doctor's Note</strong>
                    </div>
                    <div class="info-content">
                        <p class="note-text">{{ reservasi.caregiverNote|default:reservasi.caregiver_note }}</p>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Action Buttons -->
            <div class="card-actions">
                <div class="flex items-center justify-between">
                    <div class="text-xs text-gray-500">
                        {% if reservasi.createdAt %}
                        <i class="fas fa-clock mr-1"></i>
                        Created: {{ reservasi.createdAt|date:"M j, Y g:i A" }}
                        {% endif %}
                    </div>

                    <div class="flex space-x-2" data-status="{{ reservasi.statusReservasi }}"
                        data-reservation-id="{{ reservasi.id }}">
                        <!-- Actions will be generated by JS -->
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

        {% else %}
        <!-- Empty State -->
        <div class="card bg-white p-12 text-center">
            <div class="text-gray-400 mb-4">
                <i class="fas fa-calendar-times text-6xl"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-500 mb-2">No Reservations Found</h3>
            <p class="text-gray-400 mb-4">You don't have any reservations yet.</p>
            <a href="{% url 'request_reservasi' %}" class="btn-primary">
                <i class="fas fa-plus mr-2"></i> Make Your First Reservation
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Notification Container -->
<div id="notificationContainer" class="fixed top-4 right-4 z-50"></div>

<style>
    /* Base Layout */
    .container {
        max-width: 1200px;
    }

    /* Button System */
    .btn-primary,
    .btn-secondary,
    .btn-success,
    .btn-danger {
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        transition: all 0.2s ease;
        border: none;
        cursor: pointer;
        text-decoration: none;
    }

    .btn-primary {
        background: linear-gradient(135deg, #1A76D2, #0D5CAB);
        color: white;
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #0D5CAB, #073A70);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(26, 118, 210, 0.3);
    }

    .btn-secondary {
        background-color: #E8F1FC;
        color: #1A76D2;
        border: 1px solid #D4E5F9;
    }

    .btn-secondary:hover {
        background-color: #D4E5F9;
        color: #0D5CAB;
        transform: translateY(-1px);
    }

    .btn-success {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
    }

    .btn-success:hover {
        background: linear-gradient(135deg, #059669, #047857);
        transform: translateY(-1px);
    }

    .btn-danger {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
    }

    .btn-danger:hover {
        background: linear-gradient(135deg, #dc2626, #b91c1c);
        transform: translateY(-1px);
    }

    /* Card System */
    .reservation-card,
    .card {
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        background: white;
        border: 1px solid #f3f4f6;
    }

    .reservation-card {
        padding: 24px;
        margin-bottom: 16px;
    }

    .reservation-card:hover {
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
        border-color: #e5e7eb;
    }

    /* Card Components */
    .card-header {
        border-bottom: 1px solid #f3f4f6;
        margin-bottom: 16px;
        padding-bottom: 16px;
    }

    .reservation-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #1A76D2, #0D5CAB);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: white;
    }

    .reservation-title {
        font-size: 18px;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 4px;
    }

    .reservation-subtitle {
        font-size: 14px;
        color: #6b7280;
        display: flex;
        align-items: center;
    }

    /* Status Badge System */
    .status-badge {
        font-weight: 600;
        letter-spacing: 0.025em;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        text-transform: uppercase;
        display: inline-flex;
        align-items: center;
        border: 1px solid;
    }

    /* Info Sections */
    .card-content {
        margin-bottom: 20px;
    }

    .info-section {
        margin-bottom: 16px;
        padding: 12px;
        border-radius: 8px;
        border-left: 4px solid #e5e7eb;
    }

    .schedule-info {
        background-color: #F0F7FF;
        border-left-color: #1A76D2;
    }

    .note-info {
        background-color: #f9fafb;
        border-left-color: #6b7280;
    }

    .caregiver-note {
        background-color: #f0fdf4;
        border-left-color: #10b981;
    }

    .info-header {
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
    }

    .info-content {
        color: #6b7280;
    }

    .schedule-date {
        font-weight: 600;
        color: #1f2937;
        display: block;
        margin-bottom: 4px;
    }

    .schedule-time {
        color: #1A76D2;
        font-weight: 500;
    }

    .note-text {
        font-style: italic;
        line-height: 1.5;
    }

    /* Card Actions */
    .card-actions {
        border-top: 1px solid #f3f4f6;
        padding-top: 16px;
        margin-top: 16px;
    }

    /* Notification */
    .notification {
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        animation: slideIn 0.3s ease;
    }

    .notification.success {
        background: #dcfce7;
        color: #166534;
        border: 1px solid #bbf7d0;
    }

    .notification.error {
        background: #fecaca;
        color: #dc2626;
        border: 1px solid #fca5a5;
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
</style>
{% endblock content %}

{% block extra_js %}
<script>
    // Configuration
    const STATUS_CONFIG = {
        WAITING: {
            label: 'Waiting',
            icon: 'fas fa-clock',
            class: 'bg-blue-100 text-blue-800 border-blue-200',
            actions: ['edit', 'view']
        },
        APPROVED: {
            label: 'Approved',
            icon: 'fas fa-check-circle',
            class: 'bg-green-100 text-green-800 border-green-200',
            actions: ['view']
        },
        REJECTED: {
            label: 'Rejected',
            icon: 'fas fa-times-circle',
            class: 'bg-red-100 text-red-800 border-red-200',
            actions: ['view']
        },
        ON_RESCHEDULE: {
            label: 'Rescheduled',
            icon: 'fas fa-calendar-alt',
            class: 'bg-yellow-100 text-yellow-800 border-yellow-200',
            actions: ['accept', 'reject', 'view']
        }
    };

    const ACTION_CONFIG = {
        edit: {
            label: 'Edit',
            icon: 'fas fa-edit',
            class: 'btn-primary',
            handler: editReservation
        },
        accept: {
            label: 'Accept',
            icon: 'fas fa-check',
            class: 'btn-success',
            handler: acceptChange
        },
        reject: {
            label: 'Reject',
            icon: 'fas fa-times',
            class: 'btn-danger',
            handler: rejectChange
        },
        view: {
            label: 'Details',
            icon: 'fas fa-eye',
            class: 'btn-secondary',
            handler: viewDetails
        }
    };

    // Utilities
    const Utils = {
        getCookie: (name) => {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [key, value] = cookie.trim().split('=');
                if (key === name) return decodeURIComponent(value);
            }
            return null;
        },

        showNotification: (message, type = 'success') => {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="${type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle'} mr-2"></i>
                ${message}
            `;
            container.appendChild(notification);
            setTimeout(() => notification.remove(), type === 'error' ? 5000 : 3000);
        },

        makeRequest: async (url, options = {}) => {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': Utils.getCookie('csrftoken'),
                        ...options.headers
                    },
                    ...options
                });

                if (!response.ok) {
                    throw new Error(`Request failed: ${response.statusText}`);
                }

                return response;
            } catch (error) {
                Utils.showNotification(`Failed: ${error.message}`, 'error');
                throw error;
            }
        },

        confirm: (message, callback) => {
            if (confirm(message)) callback();
        }
    };

    // Action Handlers
    async function acceptChange(reservationId) {
        Utils.confirm('Are you sure you want to accept this schedule change?', async () => {
            try {
                await Utils.makeRequest(`/reservasi/${reservationId}/accept-change/`);
                Utils.showNotification('Schedule change accepted successfully!');
                setTimeout(() => window.location.reload(), 1000);
            } catch (error) {
                // Error already handled in makeRequest
            }
        });
    }

    async function rejectChange(reservationId) {
        Utils.confirm('Are you sure you want to reject this schedule change?', async () => {
            try {
                await Utils.makeRequest(`/reservasi/${reservationId}/reject-change/`);
                Utils.showNotification('Schedule change rejected successfully!');
                setTimeout(() => window.location.reload(), 1000);
            } catch (error) {
                // Error already handled in makeRequest
            }
        });
    }

    function editReservation(reservationId) {
        const reservationCard = document.querySelector(`[data-reservation-id="${reservationId}"]`);
        const caregiverId = reservationCard?.dataset?.caregiverId;

        if (caregiverId) {
            window.location.href = `/pacillian-reservation/schedules/${caregiverId}/available/?reservation_id=${reservationId}`;
        } else {
            Utils.showNotification('Unable to find doctor information for this reservation', 'error');
        }
    }

    function viewDetails(reservationId) {
        Utils.showNotification(`Viewing details for reservation #${reservationId}`);
        // TODO: Implement detailed view modal or redirect
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function () {
        // Apply status badges
        document.querySelectorAll('.status-badge').forEach(badge => {
            const status = badge.dataset.status;
            const config = STATUS_CONFIG[status];

            if (config) {
                badge.className = `status-badge ${config.class}`;
                badge.innerHTML = `<i class="${config.icon} mr-1"></i>${config.label}`;
            } else {
                badge.className = 'status-badge bg-gray-100 text-gray-800 border-gray-200';
                badge.innerHTML = `<i class="fas fa-question-circle mr-1"></i>${status || 'Unknown'}`;
            }
        });

        // Generate action buttons
        document.querySelectorAll('.card-actions .flex[data-status]').forEach(container => {
            const status = container.dataset.status;
            const reservationId = container.dataset.reservationId;
            const config = STATUS_CONFIG[status];

            if (config && config.actions) {
                container.innerHTML = config.actions.map(actionKey => {
                    const action = ACTION_CONFIG[actionKey];
                    if (action) {
                        return `
                            <button onclick="${action.handler.name}('${reservationId}')" 
                                    class="${action.class}" 
                                    title="${action.label} Reservation">
                                <i class="${action.icon} mr-1"></i> ${action.label}
                            </button>
                        `;
                    }
                    return '';
                }).join('');
            }
        });
    });
</script>
{% endblock extra_js %}