{% extends "base.html" %}
{% load static %}

{% block meta %}
<title>My Schedules - PandaCare</title>
{% endblock meta %}

{% block navbar %}
{% include "components/navbar.html" with is_logged_in=True user_role="caregiver" user_id=user_id %}
{% endblock navbar %}

{% block content %}
<div class="flex-grow container mx-auto p-6 max-w-7xl">
    <!-- Page Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h3 class="text-2xl font-bold text-gray-800">My Schedules</h3>
            <p class="text-sm text-gray-600">Manage your availability</p>
        </div>
        <div class="flex space-x-3">
            <a href="{% url 'schedule:schedule_create' user_id %}"
                class="bg-primary text-white px-4 py-2 rounded-lg text-sm hover:bg-primary-dark transition-all">
                <i class="fas fa-plus mr-1"></i> Create Schedule
            </a>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="card bg-white p-5 mb-6">
        <h3 class="font-medium mb-4">Filter Schedules</h3>
        <form method="get" class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2" for="status">Status</label>
                <select id="status" name="status"
                    class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                    <option value="">All Statuses</option>
                    <option value="AVAILABLE" {% if "AVAILABLE" in status_filter %}selected{% endif %}>Available
                    </option>
                    <option value="UNAVAILABLE" {% if "UNAVAILABLE" in status_filter %}selected{% endif %}>Unavailable
                    </option>
                    <option value="INACTIVE" {% if "INACTIVE" in status_filter %}selected{% endif %}>Inactive</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2" for="day">Day</label>
                <select id="day" name="day"
                    class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                    <option value="">All Days</option>
                    <option value="MONDAY" {% if "MONDAY" in day_filter %}selected{% endif %}>Monday</option>
                    <option value="TUESDAY" {% if "TUESDAY" in day_filter %}selected{% endif %}>Tuesday</option>
                    <option value="WEDNESDAY" {% if "WEDNESDAY" in day_filter %}selected{% endif %}>Wednesday</option>
                    <option value="THURSDAY" {% if "THURSDAY" in day_filter %}selected{% endif %}>Thursday</option>
                    <option value="FRIDAY" {% if "FRIDAY" in day_filter %}selected{% endif %}>Friday</option>
                    <option value="SATURDAY" {% if "SATURDAY" in day_filter %}selected{% endif %}>Saturday</option>
                    <option value="SUNDAY" {% if "SUNDAY" in day_filter %}selected{% endif %}>Sunday</option>
                </select>
            </div>
            <div class="flex items-end">
                <button type="submit"
                    class="bg-primary text-white px-4 py-2 rounded-lg w-full flex justify-center items-center hover:bg-primary-dark">
                    <i class="fas fa-filter mr-2"></i> Apply Filter
                </button>
            </div>
        </form>

        <!-- Clear Filters -->
        {% if status_filter or day_filter %}
        <div class="mt-3">
            <a href="{% url 'schedule:schedule_list' caregiver_id=caregiver_id %}"
                class="text-sm text-gray-600 hover:text-gray-800">
                <i class="fas fa-times mr-1"></i> Clear All Filters
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Results Summary -->
    {% if status_filter or day_filter %}
    <div class="bg-blue-50 border border-blue-200 text-blue-700 px-4 py-3 rounded mb-4">
        <p class="text-sm">
            <i class="fas fa-info-circle mr-2"></i>
            Showing {{ total_schedules }} schedule{% if total_schedules != 1 %}s{% endif %}
            {% if status_filter %}with status "{{ status_filter }}"{% endif %}
            {% if day_filter %}{% if status_filter %} and{% endif %} for "{{ day_filter|title }}"{% endif %}
        </p>
    </div>
    {% endif %}

    <!-- Schedules List -->
    <div class="space-y-4">
        {% if schedules %}
        {% for schedule in schedules %}
        <div class="card bg-white p-6">
            <div class="flex justify-between items-start">
                <!-- Left Side - Schedule Info -->
                <div class="flex-1">
                    <div class="flex items-center mb-3">
                        <div class="h-12 w-12 bg-blue-100 rounded-full flex items-center justify-center mr-4">
                            <i class="fas fa-calendar-alt text-blue-600 text-lg"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-900">
                                {{ schedule.day|title }} Schedule
                            </h3>
                            <p class="text-sm text-gray-500">
                                <i class="fas fa-clock mr-1"></i>
                                {% if schedule.date %}
                                {{ schedule.date|date:"d M Y" }}
                                {% else %}
                                <span class="text-gray-400">Date not set</span>
                                {% endif %}
                                {% if schedule.startTime and schedule.endTime %}
                                at {{ schedule.startTime }} - {{ schedule.endTime }}
                                {% endif %}
                            </p>
                        </div>
                    </div>

                    <!-- Additional Schedule Info -->
                    <div class="bg-blue-50 p-3 rounded-lg mb-3">
                        <p class="text-sm text-blue-800">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong>ID:</strong> {{ schedule.id }}
                            <i class="fas fa-calendar mr-1"></i>
                            {% if schedule.date and schedule.date != 'N/A' %}
                            {{ schedule.date }}
                            {% else %}
                            <span class="text-gray-400">Date not set</span>
                            {% endif %}
                        </p>
                    </div>
                </div>

                <!-- Right Side - Status & Actions -->
                <div class="flex flex-col items-end space-y-3">
                    <!-- Status Badge -->
                    <span class="status-badge px-3 py-2 text-sm font-medium rounded-full
                        {% if schedule.status == 'AVAILABLE' %}bg-green-100 text-green-800
                        {% elif schedule.status == 'UNAVAILABLE' %}bg-red-100 text-red-800
                        {% elif schedule.status == 'INACTIVE' %}bg-gray-100 text-gray-800
                        {% else %}bg-blue-100 text-blue-800{% endif %}">
                        {% if schedule.status == 'AVAILABLE' %}
                        <i class="fas fa-check-circle mr-1"></i> Available
                        {% elif schedule.status == 'UNAVAILABLE' %}
                        <i class="fas fa-times-circle mr-1"></i> Unavailable
                        {% elif schedule.status == 'INACTIVE' %}
                        <i class="fas fa-pause-circle mr-1"></i> Inactive
                        {% else %}
                        <i class="fas fa-calendar mr-1"></i> {{ schedule.status }}
                        {% endif %}
                    </span>

                    <!-- Action Buttons -->
                    <div class="flex space-x-2">
                        <button
                            onclick="showScheduleDetails('{{ schedule.id }}', '{{ schedule.date }}', '{{ schedule.day }}', '{{ schedule.startTime }}', '{{ schedule.endTime }}', '{{ schedule.status }}')"
                            class="text-primary hover:text-primary-dark p-2 rounded-lg hover:bg-gray-100"
                            title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>

                        {% if schedule.status == 'AVAILABLE' %}
                        <button onclick="confirmDeleteSchedule('{{ schedule.id }}')"
                            class="text-red-600 hover:text-red-800 p-2 rounded-lg hover:bg-red-50"
                            title="Delete Schedule">
                            <i class="fas fa-trash"></i>
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Additional Info for Inactive Schedules -->
            {% if schedule.status == 'INACTIVE' %}
            <div class="mt-4 pt-4 border-t border-gray-200">
                <p class="text-sm text-gray-600 bg-gray-50 p-2 rounded">
                    <i class="fas fa-info-circle mr-2"></i>
                    This schedule is currently inactive and not available for bookings.
                </p>
            </div>
            {% endif %}
        </div>
        {% endfor %}

        {% else %}
        <!-- Empty State -->
        <div class="card bg-white p-12 text-center">
            <div class="text-gray-400 mb-4">
                <i class="fas fa-calendar-plus text-6xl"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-500 mb-2">No Schedules Found</h3>
            <p class="text-gray-400 mb-6">
                {% if status_filter or day_filter %}
                No schedules match your current filters.
                <br>
                {% if status_filter %}Status: <strong>{{ status_filter }}</strong>{% endif %}
                {% if day_filter %}{% if status_filter %}, {% endif %}Day: <strong>{{ day_filter }}</strong>{% endif %}
                {% else %}
                You haven't created any schedules yet.
                {% endif %}
            </p>
            {% if status_filter or day_filter %}
            <a href="{% url 'schedule:schedule_list' caregiver_id=caregiver_id %}"
                class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 mr-3">
                <i class="fas fa-times mr-2"></i> Clear Filters
            </a>
            {% endif %}
            <a href="{% url 'schedule:schedule_create' caregiver_id=caregiver_id %}"
                class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-primary-dark">
                <i class="fas fa-plus mr-2"></i> Create New Schedule
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modals remain the same -->
<!-- Schedule Details Modal -->
<div id="scheduleDetailsModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="fixed inset-0 bg-black opacity-50" onclick="closeModal('scheduleDetailsModal')"></div>
        <div class="relative bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-medium">Schedule Details</h3>
                <button type="button" onclick="closeModal('scheduleDetailsModal')"
                    class="text-gray-400 hover:text-gray-500">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <div id="scheduleDetailsContent">
                    <!-- Content loaded dynamically -->
                </div>
                <div class="flex justify-end space-x-3 mt-6 pt-4 border-t">
                    <button onclick="closeModal('scheduleDetailsModal')"
                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteConfirmModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="fixed inset-0 bg-black opacity-50" onclick="closeModal('deleteConfirmModal')"></div>
        <div class="relative bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-medium">Delete Schedule</h3>
                <button type="button" onclick="closeModal('deleteConfirmModal')"
                    class="text-gray-400 hover:text-gray-500">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="text-center">
                    <div class="text-red-500 mb-4">
                        <i class="fas fa-exclamation-triangle text-4xl"></i>
                    </div>
                    <h4 class="text-lg font-medium text-gray-900 mb-2">Are you sure?</h4>
                    <p class="text-gray-600 mb-6">This action cannot be undone. This will permanently delete the
                        schedule.</p>
                </div>
                <div class="flex justify-end space-x-3">
                    <button onclick="closeModal('deleteConfirmModal')"
                        class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <form id="deleteForm" method="post" class="inline">
                        {% csrf_token %}
                        <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                            <i class="fas fa-trash mr-1"></i> Delete Schedule
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock content %}

{% block extra_js %}
<script>
    function openModal(modalId) {
        document.getElementById(modalId).classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    }

    function showScheduleDetails(id, date, day, startTime, endTime, status) {
        const formatDate = (date && date !== 'Not set' && date !== '') ?
            new Date(date).toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            }) : 'Recurring schedule';

        document.getElementById('scheduleDetailsContent').innerHTML = `
            <div class="space-y-4">
                <div class="flex justify-between">
                    <span class="text-sm font-medium text-gray-500">Schedule ID:</span>
                    <span class="text-sm text-gray-900">${id}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm font-medium text-gray-500">Day:</span>
                    <span class="text-sm text-gray-900">${day}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm font-medium text-gray-500">Date:</span>
                    <span class="text-sm text-gray-900">${formatDate}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm font-medium text-gray-500">Start Time:</span>
                    <span class="text-sm text-gray-900">${startTime}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm font-medium text-gray-500">End Time:</span>
                    <span class="text-sm text-gray-900">${endTime}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm font-medium text-gray-500">Status:</span>
                    <span class="status-badge px-2 py-1 text-xs font-medium rounded-full ${getStatusClass(status)}">${status}</span>
                </div>
            </div>
        `;

        openModal('scheduleDetailsModal');
    }

    function getStatusClass(status) {
        const classes = {
            'AVAILABLE': 'bg-green-100 text-green-800',
            'UNAVAILABLE': 'bg-red-100 text-red-800',
            'INACTIVE': 'bg-gray-100 text-gray-800'
        };
        return classes[status] || 'bg-blue-100 text-blue-800';
    }

    function confirmDeleteSchedule(scheduleId) {
        const deleteForm = document.getElementById('deleteForm');
        const caregiverId = '{{ caregiver_id }}';
        deleteForm.action = `/schedules/${caregiverId}/${scheduleId}/delete/`;
        openModal('deleteConfirmModal');
    }
</script>
{% endblock extra_js %}

{% block extra_style %}
<style>
    .hover\:bg-primary:hover {
        background-color: #3B82F6;
    }

    .hover\:bg-primary-dark:hover {
        background-color: #2563EB;
    }

    .focus\:ring-primary:focus {
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .focus\:border-primary:focus {
        border-color: #3B82F6;
    }

    .container {
        max-width: 1200px;
    }
</style>
{% endblock extra_style %}